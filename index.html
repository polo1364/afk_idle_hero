<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ›æ©Ÿå§ï¼å‹‡è€… â€” ç¶²é ç‰ˆåŸå‹ v0.3</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2b; --muted:#8aa0c6; --text:#e9f0ff; --accent:#6ec7ff; --lime:#8bffb0; --danger:#ff6e86; --gold:#ffd37a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans TC',sans-serif;background:radial-gradient(1200px 600px at 50% -10%,#12203a,#0b1220 60%);color:var(--text)}
    header{position:sticky;top:0;background:#0b1220d0;backdrop-filter:saturate(140%) blur(6px);z-index:10;border-bottom:1px solid #1d2a45}
    header .wrap{max-width:1120px;margin:auto;padding:10px 14px;display:flex;gap:12px;align-items:center}
    .pill{padding:4px 10px;border:1px solid #2b3b63;border-radius:999px;color:var(--muted);font-size:12px}
    main{max-width:1120px;margin:auto;padding:16px}
    .card{background:var(--panel);border:1px solid #1d2a45;border-radius:14px;box-shadow:0 6px 24px #0006}
    .body{padding:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    button{background:#162446;border:1px solid #2b3b63;color:#cfe3ff;padding:10px 12px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .btn-acc{border-color:#3c7bff;background:#17305a}
    .btn-danger{border-color:#6b2b3c;background:#3a0f18;color:#ffd4db}
    .muted{color:var(--muted)}
    h1,h2,h3{margin:0 0 8px 0}
    .center{display:flex;justify-content:center;align-items:center}
    .menu-list{display:flex;flex-direction:column;gap:10px;width:min(520px,90vw)}
    .menu-list button{width:100%;font-size:18px;padding:14px}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid #1d2a45;font-size:14px}
    th{color:#bcd2ff;text-align:left}
    .panel{padding:14px;border:1px solid #1d2a45;border-radius:12px;background:#0f1830}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .kpi .box{padding:10px;border:1px solid #1d2a45;border-radius:12px;text-align:center;background:#0f1830}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.kpi{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="font-weight:800;letter-spacing:.5px">ğŸ—¡ï¸ æ›æ©Ÿå§ï¼å‹‡è€… â€” åŸå‹ v0.3</div>
      <div class="pill" id="pill-mode">ä¸»é¸å–®</div>
      <div class="pill" id="pill-gold">Gold 0</div>
      <div class="pill" id="pill-dps">DPS 0</div>
      <div class="pill" id="pill-day">Day 0</div>
      <div style="margin-left:auto" class="muted">LocalStorage â€¢ å–®æª”</div>
    </div>
  </header>

  <main>
    <!-- Scene: Main Menu (åœ–1) -->
    <section id="scene-menu" class="center" style="min-height:70vh;flex-direction:column;gap:14px">
      <h1>æ›æ©Ÿå§ï¼å‹‡è€…</h1>
      <div class="menu-list">
        <button id="btnStory">æ•…äº‹æ¨¡å¼</button>
        <button id="btnEndless">ç„¡ç›¡æ¨¡å¼ï¼ˆåŸæ›æ©ŸåŸå‹ï¼‰</button>
        <button id="btnAchv">æˆå°±ï¼ˆé ç•™ï¼‰</button>
        <button id="btnSettings">è¨­å®š</button>
        <button id="btnCredits">è£½ä½œäººå“¡</button>
      </div>
    </section>

    <!-- Scene: Slots (åœ–2) -->
    <section id="scene-slots" class="hidden">
      <h2>é¸æ“‡å­˜æª”ï¼ˆæ•…äº‹æ¨¡å¼ï¼‰</h2>
      <div id="slotList" class="grid"></div>
      <div class="row" style="margin-top:10px"><button id="btnBackSlots">â† è¿”å›ä¸»é¸å–®</button></div>
    </section>

    <!-- Scene: Setup (åœ–3) -->
    <section id="scene-setup" class="hidden">
      <div class="grid">
        <div class="card"><div class="body">
          <h3>åœ°å€èˆ‡é›£åº¦</h3>
          <div class="row"><select id="selRegion"></select><select id="selDiff">
            <option value="Normal">æ™®é€š</option><option value="Hard">å›°é›£</option><option value="Nightmare">æƒ¡å¤¢</option></select></div>
          <div class="panel small muted">é›£åº¦å½±éŸ¿ï¼šæ•µäººç”Ÿå‘½/æ”»æ“Šã€æ‰è½ç‡èˆ‡æˆå°±é»å€ç‡ã€‚</div>
        </div></div>
        <div class="card"><div class="body">
          <h3>åˆå§‹è‹±é›„ï¼ˆæœ€å¤š 5 ä½ï¼‰</h3>
          <div id="heroPick" class="row"></div>
        </div></div>
        <div class="card"><div class="body">
          <h3>åˆå§‹ç½®ç‰©</h3>
          <div id="startPerks" class="row"></div>
          <div class="muted">æˆå°±é»ï¼š<span id="achvPts">0</span></div>
        </div></div>
        <div class="card"><div class="body center" style="gap:10px">
          <button id="btnBeginStory" class="btn-acc">å†’éšªï¼</button>
          <button id="btnBackSetup">è¿”å›</button>
        </div></div>
      </div>
    </section>

    <!-- Scene: Town (åœ–4) -->
    <section id="scene-town" class="hidden">
      <div class="kpi" style="margin-bottom:10px">
        <div class="box"><div class="muted small">ä½ç½®</div><div id="kTownRegion">æ›™å…‰ä¹‹åœ°</div></div>
        <div class="box"><div class="muted small">ç¬¬å¹¾å¤©</div><div id="kDay">1</div></div>
        <div class="box"><div class="muted small">éšŠä¼æˆ°åŠ›</div><div id="kPower">0</div></div>
        <div class="box"><div class="muted small">é€Ÿåº¦å€ç‡ä¸Šé™</div><div id="kSpeedMax">Ã—2</div></div>
      </div>
      <div class="grid">
        <div class="card"><div class="body"><h3>åŸé®</h3>
          <div class="row" style="gap:8px">
            <button id="btnHeroes">è‹±é›„</button>
            <button id="btnFormation">ç·¨çµ„</button>
            <button id="btnSmith">éµåŒ é‹ª</button>
            <button id="btnMarket">å¸‚å ´</button>
            <button id="btnTavern">é…’é¤¨</button>
            <button id="btnBlack">å•†äºº</button>
          </div></div></div>
        <div class="card"><div class="body">
          <h3>å‰å¾€å†’éšª</h3>
          <div class="row"><button id="btnToMap" class="btn-acc">åœ°åœ– â†’</button>
            <button id="btnSaveTown">ç«‹å³å­˜æª”</button>
            <button id="btnExitTown">å›ä¸»é¸å–®</button>
          </div>
        </div></div>
      </div>
    </section>

    <!-- Scene: Formation (åœ–6 ç°¡åŒ–ä½œæ¥­) -->
    <section id="scene-formation" class="hidden">
      <h3>ç·¨çµ„ï¼ˆ3Ã—2ï¼‰</h3>
      <div id="gridFormation" class="row" style="gap:6px;flex-wrap:wrap"></div>
      <div class="row" style="margin-top:10px"><button id="btnFormSave" class="btn-acc">ä¿å­˜</button><button id="btnFormBack">è¿”å›åŸé®</button></div>
    </section>

    <!-- Scene: Map (åœ–7) -->
    <section id="scene-map" class="hidden">
      <h3>åœ°åœ–ï¼š<span id="mapRegionName"></span></h3>
      <div id="mapNodes" class="row" style="margin:10px 0;gap:12px"></div>
      <div class="row"><button id="btnBackTown">â† è¿”å›åŸé®</button></div>
    </section>

    <!-- Scene: Battle (åœ–8 ç°¡åŒ–) -->
    <section id="scene-battle" class="hidden">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btnBattleSpd">é€Ÿåº¦ Ã—<span id="lblSpd">1</span></button>
          <span class="muted">ç¯€é»ï¼š<span id="lblNode"></span></span>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnRetreat">æ’¤é€€</button>
        </div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div class="card"><div class="body">
          <h3>æˆ°å ´</h3>
          <div class="panel" id="battleLog" style="max-height:240px;overflow:auto"></div>
        </div></div>
        <div class="card"><div class="body">
          <h3>éšŠä¼ç‹€æ…‹</h3>
          <div id="partyView"></div>
        </div></div>
      </div>
      <div class="row" style="margin-top:10px"><button id="btnBattleNext" class="btn-acc hidden">è¿”å›åœ°åœ–</button></div>
    </section>

    <!-- Scene: Endlessï¼ˆæ²¿ç”¨åŸæ›æ©ŸåŸå‹ï¼‰ -->
    <section id="scene-endless" class="hidden">
      <div class="card"><div class="body" id="endlessMount"></div></div>
      <div class="row" style="margin-top:8px"><button id="btnBackFromEndless">â† è¿”å›ä¸»é¸å–®</button></div>
    </section>
  </main>

  <script>
  // ========= å¯¦ç”¨ =========
  const fmt = (n)=>Number(n).toLocaleString();
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const choice=(arr)=>arr[Math.floor(Math.random()*arr.length)];

  // ========= å ´æ™¯ç®¡ç† =========
  const Scenes = ['menu','slots','setup','town','formation','map','battle','endless'];
  let CUR = 'menu';
  function goto(scene){
    Scenes.forEach(s=>document.getElementById('scene-'+s).classList.add('hidden'));
    document.getElementById('scene-'+scene).classList.remove('hidden');
    CUR = scene; document.getElementById('pill-mode').textContent = scene.toUpperCase();
  }

  // ========= æ•…äº‹æ¨¡å¼è³‡æ–™éª¨æ¶ =========
  const BASE_HEROES = [
    {id:'kaira',name:'å‡±æ‹‰',job:'æˆ°å£«'},
    {id:'wendy',name:'æº«è’‚',job:'å¦å…‹'},
    {id:'jesse',name:'å‚‘è¥¿',job:'å°„æ‰‹'},
    {id:'jennifer',name:'çå¦®ä½›',job:'æ³•å¸«'},
    {id:'hunter',name:'æ‚ç‰¹',job:'ç‰§å¸«'},
  ];
  const REGIONS = [
    {id:'dawn',name:'æ›™å…‰ä¹‹åœ°', nodes:6},
    {id:'riot',name:'å‹•äº‚ä¹‹åœ°', nodes:8},
    {id:'forget',name:'è¿½å¿˜ä¹‹åœ°', nodes:10},
    {id:'etern',name:'æ°¸åŠ«ä¹‹åœ°', nodes:12},
  ];

  function blankStoryState(){
    return { mode:'story', day:1, gold:1000, region:'dawn', difficulty:'Normal', heroes:[], formation:[null,null,null,null,null,null], bestNode:0, speedMax:2 };
  }

  const SLOT_KEY = (i)=>`afk-hero-slot-${i}`;
  function loadSlot(i){ try{ return JSON.parse(localStorage.getItem(SLOT_KEY(i))||'null'); }catch{ return null } }
  function saveSlot(i,data){ localStorage.setItem(SLOT_KEY(i), JSON.stringify(Object.assign({updatedAt:Date.now()},data))); }
  function deleteSlot(i){ localStorage.removeItem(SLOT_KEY(i)); }

  // ========= UIï¼šæª”ä½ =========
  function renderSlots(){
    const wrap=document.getElementById('slotList'); wrap.innerHTML='';
    for(let i=1;i<=3;i++){
      const S=loadSlot(i);
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `<div class="body"><h3>å­˜æª” ${i}</h3>
        <div class="muted">${S? `Day ${S.day} Â· ${REGIONS.find(r=>r.id===S.region)?.name||''} Â· ${S.difficulty}`:'ç©ºçš„'}</div>
        <div class="row" style="margin-top:8px">
          <button data-a="play">${S?'ç¹¼çºŒ':'æ–°å»º'}</button>
          <button data-a="rename">æ”¹åï¼ˆé ç•™ï¼‰</button>
          <button data-a="delete" class="btn-danger">åˆªé™¤</button>
        </div></div>`;
      card.querySelector('[data-a="play"]').onclick=()=>{ currentSlot=i; if(S){ Story=S; goto('town'); syncTown(); } else { Story=blankStoryState(); goto('setup'); setupInit(); } };
      card.querySelector('[data-a="delete"]').onclick=()=>{ if(confirm('åˆªé™¤æ­¤å­˜æª”ï¼Ÿ')){ deleteSlot(i); renderSlots(); } };
      wrap.appendChild(card);
    }
  }

  // ========= Setupï¼ˆåœ°å€/é›£åº¦/è‹±é›„/ç½®ç‰©ï¼‰ =========
  let Story = blankStoryState(); let currentSlot=1;
  function setupInit(){
    const selR=document.getElementById('selRegion'); selR.innerHTML='';
    REGIONS.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; selR.appendChild(o); });
    document.getElementById('selDiff').value=Story.difficulty;
    document.getElementById('achvPts').textContent = 20; // å‡è³‡æ–™ï¼š20 é»å¯èŠ±
    // è‹±é›„
    const hp=document.getElementById('heroPick'); hp.innerHTML='';
    BASE_HEROES.forEach(h=>{
      const b=document.createElement('button'); b.textContent=`${h.name}ï¼ˆ${h.job}ï¼‰`;
      b.onclick=()=>{
        const idx = Story.heroes.findIndex(x=>x.id===h.id);
        if(idx>=0){ Story.heroes.splice(idx,1); b.style.outline=''; }
        else if(Story.heroes.length<5){ Story.heroes.push(Object.assign({level:1},h)); b.style.outline='2px solid #3c7bff'; }
      };
      hp.appendChild(b);
    });
    // ç½®ç‰©ï¼ˆç°¡åŒ–ï¼šé‡‘å¹£+5000 / è£å‚™åœ–é‘‘ç­‰ç´š+1ï¼‰
    const sp=document.getElementById('startPerks'); sp.innerHTML='';
    ['é‡‘å¹£+5000','å»ºç¯‰ç­‰ç´š+1','è£å‚™åœ–é‘‘ç­‰ç´š+1'].forEach((name,i)=>{
      const b=document.createElement('button'); b.textContent=name; b.onclick=()=>alert('ç¤ºæ„ï¼šæ¶ˆè€—æˆå°±é»ï¼Œå¾…å¯¦ä½œ'); sp.appendChild(b);
    });
  }

  document.getElementById('btnBeginStory').onclick=()=>{
    Story.region = document.getElementById('selRegion').value;
    Story.difficulty = document.getElementById('selDiff').value;
    if(Story.heroes.length===0){ alert('è«‹è‡³å°‘é¸ 1 ä½è‹±é›„'); return; }
    saveSlot(currentSlot, Story);
    goto('town'); syncTown();
  };
  document.getElementById('btnBackSetup').onclick=()=>{ goto('slots'); };

  // ========= åŸé® =========
  function syncTown(){
    document.getElementById('kTownRegion').textContent = REGIONS.find(r=>r.id===Story.region)?.name || '';
    document.getElementById('kDay').textContent = Story.day;
    document.getElementById('kPower').textContent = Story.heroes.length*100;
    document.getElementById('kSpeedMax').textContent = `Ã—${Story.speedMax}`;
    document.getElementById('pill-gold').textContent = `Gold ${fmt(Story.gold||0)}`;
    document.getElementById('pill-day').textContent = `Day ${fmt(Story.day)}`;
  }
  document.getElementById('btnToMap').onclick=()=>{ renderMap(); goto('map'); };
  document.getElementById('btnExitTown').onclick=()=>{ goto('menu'); };
  document.getElementById('btnSaveTown').onclick=()=>{ saveSlot(currentSlot, Story); alert('å·²å„²å­˜'); };
  document.getElementById('btnHeroes').onclick=()=>{ alert('è‹±é›„é¢æ¿é ç•™ï¼ˆv0.4ï¼‰'); };
  document.getElementById('btnSmith').onclick=()=>{ alert('éµåŒ é‹ªé ç•™ï¼ˆv0.5ï¼‰'); };
  document.getElementById('btnMarket').onclick=()=>{ alert('å¸‚å ´é ç•™'); };
  document.getElementById('btnTavern').onclick=()=>{ alert('é…’é¤¨é ç•™'); };
  document.getElementById('btnBlack').onclick=()=>{ alert('é»‘å¸‚é ç•™'); };
  document.getElementById('btnFormation').onclick=()=>{ renderFormation(); goto('formation'); };

  // ========= ç·¨çµ„ =========
  function renderFormation(){
    const gf=document.getElementById('gridFormation'); gf.innerHTML='';
    for(let i=0;i<6;i++){
      const div=document.createElement('div'); div.className='panel'; div.style.width='110px'; div.style.height='64px';
      const hero = Story.formation[i] && Story.heroes.find(h=>h.id===Story.formation[i]);
      div.textContent = hero? `${hero.name}`: `æ ¼ ${i+1}`;
      div.onclick=()=>{
        const pick=prompt('æ”¾å…¥è‹±é›„ç·¨è™Ÿï¼ˆ0~'+(Story.heroes.length-1)+'ï¼‰ï¼Œæˆ–ç•™ç©ºç§»é™¤');
        if(pick===''||pick===null){ Story.formation[i]=null; }
        else{ const idx=parseInt(pick); if(!isNaN(idx)&&Story.heroes[idx]) Story.formation[i]=Story.heroes[idx].id; }
        renderFormation();
      };
      gf.appendChild(div);
    }
  }
  document.getElementById('btnFormSave').onclick=()=>{ saveSlot(currentSlot, Story); alert('å·²ä¿å­˜ç·¨çµ„'); };
  document.getElementById('btnFormBack').onclick=()=>{ goto('town'); };

  // ========= åœ°åœ– =========
  function renderMap(){
    document.getElementById('mapRegionName').textContent = REGIONS.find(r=>r.id===Story.region)?.name || '';
    const wrap=document.getElementById('mapNodes'); wrap.innerHTML='';
    const R = REGIONS.find(r=>r.id===Story.region); const n = R.nodes;
    for(let i=0;i<n;i++){
      const btn=document.createElement('button'); btn.textContent = i===n-1? `Boss ${i+1}` : `ç¯€é» ${i+1}`;
      btn.disabled = i>Story.bestNode+1; // è§£é–åˆ°ä¸‹ä¸€å€‹
      btn.onclick=()=>startBattle(i);
      wrap.appendChild(btn);
    }
  }
  document.getElementById('btnBackTown').onclick=()=>{ goto('town'); };

  // ========= ç°¡åŒ–æˆ°é¬¥ï¼ˆæ¡ç”¨æœŸæœ›å€¼æ¼”ç®— + æ—¥èªŒè¼¸å‡ºï¼‰ =========
  let BTL = {speed:1};
  function partyPower(){ return Story.heroes.length? Story.heroes.length* (150 + (Story.day*5)) : 100; }
  function enemyForNode(node){
    const base = 1.15 ** node; const boss = node % (REGIONS.find(r=>r.id===Story.region).nodes-1) === 0 && node>0;
    let hp = 400*base * (boss? 6:1); let atk = 30*base * (boss? 1.5:1);
    // é›£åº¦å€ç‡
    const diff = Story.difficulty==='Hard'? {hp:1.6, atk:1.2}: Story.difficulty==='Nightmare'? {hp:2.2, atk:1.5}: {hp:1, atk:1};
    hp*=diff.hp; atk*=diff.atk;
    return {name: boss?'Boss':'æ€ªç‰©', hp:Math.floor(hp), atk:Math.floor(atk)}
  }

  function startBattle(node){
    BTL={speed:1,node,enemy:enemyForNode(node),t:0,done:false};
    document.getElementById('lblSpd').textContent='1';
    document.getElementById('lblNode').textContent = node+1;
    const log=document.getElementById('battleLog'); log.innerHTML='';
    const party = partyPower();
    appendLog(`é­é‡ ${BTL.enemy.name}ï¼ˆHP ${fmt(BTL.enemy.hp)} / ATK ${fmt(BTL.enemy.atk)}ï¼‰`);
    goto('battle');

    // ç°¡åŒ–æ¨¡æ“¬ï¼šæ¯ 0.5s æˆ‘æ–¹èˆ‡æ•µæ–¹äº’æ›å‚·å®³
    let timer = setInterval(()=>{
      if(BTL.done){ clearInterval(timer); return; }
      const myDPS = party/20; // ç²—ç³™æœŸæœ›
      const enemyDPS = BTL.enemy.atk/3;
      BTL.enemy.hp -= myDPS * 0.5 * BTL.speed;
      const teamHP = (Story.heroes.length*300) - enemyDPS * 0.5 * BTL.speed * (1+node*0.05);
      appendLog(`æˆ‘æ–¹é€ æˆ ${fmt(Math.max(1,Math.floor(myDPS*0.5*BTL.speed)))}, æ•µæ–¹å‰© ${fmt(Math.max(0,Math.floor(BTL.enemy.hp)))}`);
      if(BTL.enemy.hp<=0){
        appendLog('å‹åˆ©ï¼ç²å¾—é‡‘å¹£èˆ‡ç´ æã€‚');
        Story.gold += 200 + node*20; Story.bestNode=Math.max(Story.bestNode,node); saveSlot(currentSlot, Story);
        document.getElementById('btnBattleNext').classList.remove('hidden'); BTL.done=true; syncTown();
      }
      if(teamHP<=0){ appendLog('æ•—åŒ—â€¦ è¿”å›ä¸Šä¸€ç¯€é»'); Story.bestNode=Math.max(0,Story.bestNode-1); saveSlot(currentSlot, Story); document.getElementById('btnBattleNext').classList.remove('hidden'); BTL.done=true; }
    }, 500);
  }
  function appendLog(msg){ const d=document.getElementById('battleLog'); const p=document.createElement('div'); p.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; d.prepend(p); while(d.children.length>80) d.lastChild.remove(); }
  document.getElementById('btnBattleSpd').onclick=()=>{ BTL.speed = BTL.speed>= (Story.speedMax||2) ? 1 : BTL.speed+0.5; document.getElementById('lblSpd').textContent=BTL.speed; };
  document.getElementById('btnRetreat').onclick=()=>{ document.getElementById('btnBattleNext').classList.remove('hidden'); appendLog('æ’¤é€€ï¼Œè¿”å›åœ°åœ–'); BTL.done=true; };
  document.getElementById('btnBattleNext').onclick=()=>{ document.getElementById('btnBattleNext').classList.add('hidden'); goto('map'); renderMap(); };

  // ========= ç„¡ç›¡æ¨¡å¼ï¼ˆæ²¿ç”¨ v0.2 æ ¸å¿ƒï¼Œä½†ç°¡åŒ–æ›è¼‰ï¼‰ =========
  // ç›´æ¥å‹•æ…‹æ³¨å…¥ä¸€å€‹è¿·ä½ æ›æ©Ÿå ´æ™¯ï¼ˆä¿ç•™ä½ ä¹‹å‰çš„è¨­è¨ˆç†å¿µï¼‰
  let Endless = null;
  function mountEndless(){
    const root=document.getElementById('endlessMount');
    root.innerHTML = `<div class="row"><button id=edStart class=btn-acc>â–¶ é–‹å§‹/æš«åœ</button><button id=edNext>â­ ä¸‹ä¸€é—œ</button><button id=edFast>â© Ã—<span id=edSpd>1</span></button></div>
      <div class=panel id=edLog style="margin-top:8px;max-height:240px;overflow:auto"></div>`;
    Endless = {stage:1,gold:0,spd:1,hp:200,max:200,running:true};
    const log=(m)=>{ const d=document.getElementById('edLog'); const p=document.createElement('div'); p.textContent=m; d.prepend(p); };
    document.getElementById('edStart').onclick=()=>{Endless.running=!Endless.running};
    document.getElementById('edNext').onclick=()=>{Endless.stage++; Endless.hp=Endless.max=Math.floor(Endless.max*1.17)};
    document.getElementById('edFast').onclick=()=>{Endless.spd=Endless.spd>=2?1:Endless.spd+1; document.getElementById('edSpd').textContent=Endless.spd;};
    let prev=performance.now();
    function loop(now){ const dt=(now-prev)/1000; prev=now; if(Endless?.running){ Endless.hp -= 20*dt*Endless.spd; if(Endless.hp<=0){Endless.gold+=10*Endless.stage; Endless.stage++; Endless.max=Math.floor(Endless.max*1.17); Endless.hp=Endless.max; log(`â†’ Stage ${Endless.stage}`);} }
      requestAnimationFrame(loop); }
    requestAnimationFrame(loop);
  }

  // ========= ä¸»é¸å–®äº‹ä»¶ =========
  document.getElementById('btnStory').onclick=()=>{ renderSlots(); goto('slots'); };
  document.getElementById('btnEndless').onclick=()=>{ goto('endless'); mountEndless(); };
  document.getElementById('btnBackFromEndless').onclick=()=>{ goto('menu'); };
  document.getElementById('btnBackSlots').onclick=()=>{ goto('menu'); };

  // å•Ÿå‹•
  goto('menu');
  </script>
</body>
</html>
